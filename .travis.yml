dist: trusty
sudo: required
language: bash
env:
  global:
  - TF_VERSION="0.12.19"
  - TFLINT_VERSION="0.13.4"
before_install:
- curl https://raw.githubusercontent.com/express42/otus-homeworks/2019-11/run.sh |
  bash
- wget https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip -O /tmp/terraform.zip
- sudo unzip -d /usr/local/bin/ /tmp/terraform.zip
- wget https://github.com/terraform-linters/tflint/releases/download/v${TFLINT_VERSION}/tflint_linux_amd64.zip -O /tmp/tflint.zip
- sudo unzip -d /usr/local/bin/ /tmp/tflint.zip

install:
- sudo pip install -r ansible/requirements.txt

script:
- ansible --version
- ansible-lint --version
- terraform --version
- packer --version
- find . -type f -name '*.tf' -exec terraform fmt {} \;
- cp terraform/prod/terraform.tfvars.example terraform/prod/terraform.tfvars
- cp terraform/stage/terraform.tfvars.example terraform/stage/terraform.tfvars
- terraform get terraform/stage
- find terraform/stage -type f -name '*.tf' -exec tflint --ignore-module=SweetOps/storage-bucket/google {} \;
- terraform get terraform/prod
- find terraform/prod -type f -name '*.tf' -exec tflint --ignore-module=SweetOps/storage-bucket/google {} \;
- find . -type f -name '*.json' -exec packer validate -var-file=packer/variables.json.example {} \;
- find . -type f -name '*.yml' -exec ansible-lint {} \;

branches:
  only:
    - ansible-3
    - master

notifications:
  slack:
    rooms:
      secure: X9gQpUYa43+Tc0VkiuhK8N6NUO4zDgawOfH4b2xHZy/rFQ2xxptD9CCtVrAD3QMXdi7bS25jTKsBgQc9Wm5hyaJ+cpqE6HVzmJzOLk9oUCjPKsmh9/QYPJgSU9EGlXqDIQinVPl3YkurPpyMzAJsjkGfELGGCR8NBGle3/EUEc1JeRBi0y7ITWYO4ZdqSG3yz84EFaqPEnwB/SP8XoVYsLgqglNJVrDyCkB7i29bwqOOgwUqEKeby/NJrHI6WIXrwp0m8IrrATS8fal+oB+jbX4etKg3Z396fesE3jrbDyv8DCfGpqBEUIaqouHJfCD/weZgqY59LPsuJP1kZYj69FlvVj3lkWtu7TPrUI5Q4O3/vYlbVz1/2g3Ctk09bIgmj97zGovrlVwaM25qWlFhfLdo/0bpLt5O8Bs7ItxLmAgHAylVNMllK5zQic/748glKqnxbMrg6sJYEDyO0K2p1OUgo5NZi2k+uR9YpcgbSGX5wkLnA6ZoNrXxkQDTTUvDw4ZAK8n9ZvN6OV/pMhg4jcAkeoOQ5nDKuPApC/bHAfaAIPnDwPKF3UdXO19wurGlddfNShCinhRssM21AltXUsDFu0dfRT24LvJwQrHRiR5JzVzuCCbkwGqqChqk1A8kY2Zuqd1d17idzVynRooKxQ2/5a4uiV5fEeggGCr/tYo=
